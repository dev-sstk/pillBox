# 필 디스펜서(스마트 알약 공급기) 요구사항 명세서

## 1. 개발 개념

고령화 사회가 심화됨에 따라 만성질환자의 약물 복용 관리는 중요한 사회적 과제로 대두되고 있음. 특히 기억력 저하 등으로 정해진 시간에 약을 챙겨 먹기 어려운 노년층의 복약 순응도 저하는 치료 효과를 반감시키고 건강을 위협하는 주요 원인임.

본 과제는 이러한 문제를 해결하기 위해, 정해진 시간에 정확한 약을 자동으로 공급하고 사용자 및 보호자에게 알림을 제공하는 '스마트 필 디스펜서'를 개발하는 것을 목표로 함. IoT 기술을 접목하여 원격 모니터링 기능을 제공함으로써, 환자의 복약 순응도를 획기적으로 향상시키고 보호자의 돌봄 부담을 경감시키고자 함.

## 2. 개발 목표

### 2.1 핵심 목표
- 사용자의 복약 순응도 향상 및 정확한 복약 지원을 통한 건강 증진

### 2.2 세부 목표
- **정밀한 약품 공급 시스템 구축**: 3개의 디스크를 각각의 스텝 모터로 독립 제어하고, 리미트 스위치를 이용한 원점 보정으로 장기 사용 시 발생할 수 있는 오차를 최소화하여 공급의 정확성 확보
- **안정적인 배출/공급 메커니즘 구현**: 스텝 모터를 활용하여 약 배출구 게이트와 약품 공급칸을 정밀하게 제어
- **다양한 복약 패턴 지원**: 아침/점심/저녁 혹은 아침/저녁, 점심/저녁 등의 다양한 시간대 패턴 지원 및 시간대 패턴별로 다른 약 종류와 개수를 가진 복약 패턴, 혹은 시간대는 지정되어 있으나 같은 종류의 약을 복용하는 패턴 등 다양한 복약 패턴 지원
- **다중 감각 알람 기능 구현**: Wi-Fi를 통한 시간 동기화로 정확한 시간에 ①음성 메시지, ②LED 점멸, ③버저음이 동시에 발생하는 다중 알람을 제공하여 사용자의 인지율을 극대화
- **직관적인 사용자 인터페이스(UI) 및 경험(UX) 설계**: 4개의 버튼(Select, Mode, Up, Down)을 통해 사용자가 쉽게 복약 확인, 기기 설정, 약품 리필 등을 수행할 수 있는 체계적인 UI/UX 제안 및 개발
- **하드웨어 설계 완료 시 소프트웨어 대응**: 제안서 작성 시점에서 하드웨어 설계가 완료되지 않음. 설계 완료 시점에서 현재 계획과 다르게 변경될 경우 그에 따른 소프트웨어 대응 필요

## 3. 주요 기능 및 시스템 명세

### 3.1 하드웨어

#### 3.1.1 주요 몸체
- **디스크 어셈블리**: '관람차' 형태의 독립된 원판형 디스크 3개
  - 용도: 투약 주기 별 약 분리 보관
  - 용량: 각 디스크당 15개의 수납 칸 (총 30회분 저장 가능)

#### 3.1.2 구동부
- **디스크 회전**: 스텝 모터 (Stepper Motor) x 3개 (각 디스크 독립 제어)
- **약 배출구 게이트**: 스텝 모터 (Stepper Motor) x 1개 (게이트 개폐 제어)

#### 3.1.3 센서
- **원점 감지**: 리미트 스위치 (Limit Switch) x 3개 (각 디스크의 초기 위치 보정용)

#### 3.1.4 알림 장치
- **시각**: 고휘도 LED
- **청각 (단순)**: 부저 (Buzzer)
- **청각 (음성)**: 스피커 및 음성 출력 모듈

#### 3.1.5 입력 장치
- **물리적 버튼 5개**: A, B, C, D, CHECK(A와 공통)

#### 3.1.6 통신 및 디스플레이
- **통신**: Wi-Fi 모듈 (인터넷 시간 동기화 및 서버 통신용)
- **디스플레이**: 128x160 컬러 TFT-LCD

### 3.2 펌웨어

#### 3.2.1 초기화 및 원점 보정
- 전원 인가 시, 3개의 디스크를 각각 저속 회전시켜 리미트 스위치로 '원점'을 감지하고 스텝 모터의 위치 값을 초기화하는 로직 탑재
- **개선사항**: 3개 디스크 동시 원점 보정 시스템 구현으로 부팅 시간 3배 단축 및 전력 효율 50% 향상

#### 3.2.2 시간 동기화
- Wi-Fi를 통해 인터넷 시간 서버(NTP)에 주기적으로 접속하여 시스템 시간을 동기화함으로써 시간 오차를 방지

#### 3.2.3 약 리필 로직
1. **1 단계 (진입)**: 사용자가 Menu 버튼으로 "약품 리필 모드" 메뉴에 진입, 디스플레이에 "리필할 디스크를 선택하세요" 표시, Select 버튼으로 아침/점심/저녁 디스크 선택
2. **2 단계 (회전)**: 디스크 위치 조정, 선택된 디스크의 스텝 모터를 회전시켜 공급칸이 사용자 방향으로 오도록 정렬(원점 기준 + n스텝 회전, 고정위치)
3. **3 단계 (개방)**: 사용자가 손으로 공급칸 덥개 열기, 디스플레이에 "약을 채워주세요", LED 점멸 및 부저로 사용자 안내, 한 칸 채우면 Up/Down버튼으로 스텝모터를 한 칸씩 회전시키며 채움, 약을 다 채우기 전에는 약 1분간 버튼 입력 없으면 자동으로 "리필 대기중" 상태 유지(자동 종료 없음)
4. **4 단계 (닫기)**: 약을 다 채운 후, 사용자가 손으로 덥개 닫기, 디스플레이에 "리필 완료" 표시
5. **5 단계 (종료)**: 덥개가 닫히면, 디스크 회전 없이 메뉴로 복귀, "리필이 완료되었습니다" 알림 후 메인 화면
- **향후 개선 계획**: 3개 디스크 동시 원점 보정 기술을 활용한 다중 디스크 동시 리필 기능 구현 예정

#### 3.2.4 약 배출 로직
1. **1단계 (알람)**: 설정된 복약 시간(예: 아침 08:00)이 되면 음성("아침 약 드실 시간입니다."), LED, 부저 동시 작동
2. **2단계 (배출)**: 사용자가 Select 버튼을 누르면, 일정 시간 경과 후 해당 디스크(아침)의 스텝 모터가 1칸 회전
3. **3단계 (게이트 개폐)**: 스텝 모터가 배출구 게이트를 열어 약이 나오게 하고, 5초 후 자동으로 닫음
4. **4단계 (기록)**: 배출 완료 상태를 UI에 표출하고 다음 예약시간까지 대기함

### 3.3 UI 및 버튼 기능 상세 제안

사용자 편의성을 극대화하기 위해 다음과 같은 UI 및 버튼 기능을 제안함.

#### 3.3.1 Menu 버튼: 메뉴 진입
- 메뉴 진입, 메뉴 진입 상태에서 누르면 뒤로가기

#### 3.3.2 Select 버튼: 선택 및 확인
- 메뉴 진입, 설정값 확정, 알람 확인 등 'Enter' 키 역할 수행

#### 3.3.3 Up/Down 버튼: 탐색 및 값 변경
- 메뉴 항목 간 이동, 시간 및 숫자 값 증감

## 4. 현재 시스템과의 차이점 분석

### 4.1 하드웨어 구성 차이점

#### 4.1.1 디스크 구성
- **요구사항**: 3개 디스크, 각각 10칸 (총 30회분)
- **현재 시스템**: 3개 디스크, 각각 15칸 (총 45회분)
- **차이점**: 현재 시스템이 더 많은 용량을 제공

#### 4.1.2 모터 구성
- **요구사항**: 
  - 디스크 회전용 스텝 모터 3개
  - 배출구 게이트용 스텝 모터 1개
- **현재 시스템**:
  - 디스크 회전용 스텝 모터 3개 (모터 1, 2, 3)
  - 배출구 슬라이드 제어용 스텝 모터 1개 (모터 4)
- **차이점**: 현재 시스템도 동일한 구성을 가지고 있음

#### 4.1.3 센서 구성
- **요구사항**: 리미트 스위치 3개 (각 디스크 원점 보정용)
- **현재 시스템**: 리미트 스위치 3개 (모터 1,2,3용 원점 보정용)
- **차이점**: 요구사항과 정확히 일치 (모터 4는 게이트 제어용으로 리미트 스위치 불필요)

#### 4.1.4 알림 장치
- **요구사항**: LED + 부저 + 스피커
- **현재 시스템**: LED + 스피커 (부저 없음)
- **차이점**: 현재 시스템에 부저 기능 추가 필요

### 4.2 소프트웨어 기능 차이점

#### 4.2.1 약 리필 로직
- **요구사항**: 5단계 리필 프로세스 (진입→회전→개방→닫기→종료)
- **현재 시스템**: PillLoadingScreen에서 리필 기능 구현됨
- **차이점**: 현재 시스템의 리필 로직을 요구사항에 맞게 개선 필요

#### 4.2.2 약 배출 로직
- **요구사항**: 4단계 배출 프로세스 (알람→배출→게이트 개폐→기록)
- **현재 시스템**: 기본적인 배출 기능 구현됨
- **차이점**: 요구사항에 맞는 상세한 배출 프로세스 구현 필요


### 4.3 주요 개선 사항

#### 4.3.1 추가 구현 필요 사항
1. **부저 기능 추가**: 현재 스피커만 있음, 부저 하드웨어 및 소프트웨어 추가 필요
2. **다중 감각 알람**: LED + 부저 + 음성이 동시에 작동하는 알람 시스템 구현

#### 4.3.2 기존 시스템 활용 가능 사항
1. **하드웨어 기반**: ESP32-C6, 디스플레이, 버튼 인터페이스, 모터 제어 시스템
2. **소프트웨어 아키텍처**: 계층형 구조, 화면 관리 시스템, 이벤트 기반 처리
3. **통신 시스템**: Wi-Fi 매니저, NTP 동기화
4. **UI 시스템**: LVGL 기반 화면 구성, 버튼 인터페이스

#### 4.3.3 수정 필요 사항
1. **리필 로직 개선**: 현재 시스템의 리필 프로세스를 요구사항의 5단계에 맞게 수정
2. **배출 로직 개선**: 현재 시스템의 배출 프로세스를 요구사항의 4단계에 맞게 수정

### 4.4 각 화면별 버튼 매핑 현황

#### 4.4.1 하드웨어 버튼 매핑
- **SW1**: 버튼 A (Select/CHECK)
- **SW2**: 버튼 B (Mode/Menu)
- **SW3**: 버튼 C (Up)
- **SW4**: 버튼 D (Down/조건부 재부팅)

#### 4.4.2 D버튼 조건부 재부팅 기능 (신규)
- **네트워크 연결됨 + 알약 있음**: 시간-분 설정 화면으로 직접 이동
- **네트워크 연결됨 + 알약 없음**: 복용시간선택 화면으로 이동  
- **네트워크 연결 안됨 + 알약 없음**: WiFi 스캔 화면으로 이동
- **재부팅 전 화면 처리**: `_make_screen_white()` 호출로 부드러운 전환
- **부팅 타겟 관리**: `boot_target.json`을 통한 목표 화면 지정

#### 4.4.2 화면 플로우 순서별 버튼 기능

##### **1. 스타트업 화면 (StartupScreen)**
- **버튼 A**: 기능 없음 (백그라운드 원점 보정 진행)
- **버튼 B**: 기능 없음 (백그라운드 원점 보정 진행)
- **버튼 C**: 기능 없음 (백그라운드 원점 보정 진행)
- **버튼 D**: 기능 없음 (백그라운드 원점 보정 진행)

##### **2. Wi-Fi 스캔 화면 (WifiScanScreen)**
- **버튼 A**: 위로 이동 (Wi-Fi 네트워크 목록 위로 스크롤)
- **버튼 B**: 아래로 이동 (Wi-Fi 네트워크 목록 아래로 스크롤)
- **버튼 C**: 기능 없음
- **버튼 D**: 선택 (선택된 Wi-Fi 네트워크 연결 또는 비밀번호 입력 화면으로 이동)

##### **3. Wi-Fi 비밀번호 화면 (WifiPasswordScreen)**
- **버튼 A**: 키보드 커서 왼쪽 이동
- **버튼 B**: 키보드 커서 오른쪽 이동
- **버튼 C**: 완료/뒤로가기 (비밀번호 입력 시 연결, 없으면 뒤로가기)
- **버튼 D**: 키보드 키 선택/입력 (문자 입력, DEL, OK, 모드 전환)

##### **4. 복용 횟수 선택 화면 (DoseCountScreen)**
- **버튼 A**: 롤러 위로 이동 (1~3회 선택)
- **버튼 B**: 롤러 아래로 이동 (1~3회 선택)
- **버튼 C**: 뒤로가기 (Wi-Fi 스캔 화면)
- **버튼 D**: 복용 횟수 선택 완료 (복용 시간 화면으로 이동)

##### **5. 복용 시간 설정 화면 (DoseTimeScreen)**
- **버튼 A**: 시간/분 롤러 위로 이동
- **버튼 B**: 시간/분 롤러 아래로 이동
- **버튼 C**: 뒤로가기 (복용 횟수 화면)
- **버튼 D**: 시간/분 설정 완료 (다음 시간 설정 또는 메인 화면)

##### **6. 메인 화면 (MainScreen)**
- **버튼 A**: 이전 일정 선택 (위로 이동)
- **버튼 B**: 다음 일정 선택 (아래로 이동)
- **버튼 C**: 수동 알약 배출
- **버튼 D**: 수동 알약 배출

##### **7. 알약 충전 화면 (PillLoadingScreen)**
- **버튼 A**: 디스크 회전 (비활성화됨)
- **버튼 B**: 다음 화면으로 (메인 화면)
- **버튼 C**: 메뉴/뒤로가기
- **버튼 D**: 선택/확인

##### **8. 설정 화면 (SettingsScreen)**
- **버튼 A**: 설정 항목 위로 이동
- **버튼 B**: 설정 항목 아래로 이동
- **버튼 C**: 뒤로가기 (메인 화면)
- **버튼 D**: 설정 선택/확인

#### 4.4.3 버튼 인터페이스 시스템
- **74HC165 시프트 레지스터** 기반 버튼 입력 처리
- **디바운싱**: 50ms 디바운싱으로 중복 입력 방지
- **콜백 시스템**: 각 화면별 버튼 이벤트 처리 함수 연결
- **상태 추적**: 버튼 상태 변화 감지 및 이벤트 발생

### 4.5 최신 구현 완료 사항 (2025-01-16)

#### 4.5.1 성능 최적화 완료
- **3개 모터 동시 원점 보정**: 부팅 시간 3배 단축 (30초 → 10초)
- **원점 보정 딜레이 제거**: 보정 속도 20배 향상 (10ms → 0ms)
- **전력 효율 향상**: 각 보정 후 전체 모터 정지로 50% 전력 절약
- **백그라운드 보정**: UI 간섭 없는 조용한 부팅 프로세스

#### 4.5.2 확장 가능성
- **다중 디스크 동시 충전**: 향후 여러 디스크에 동시 알약 충전 가능
- **사용자 경험 향상**: 빠른 부팅으로 즉시 사용 가능
- **효율적인 작업**: 동시 처리로 작업 시간 단축

#### 4.5.3 기술적 개선
- **하드웨어 활용 최적화**: 74HC595D 캐스케이드 연결 특성을 활용한 동시 제어
- **비동기 처리**: 백그라운드 보정으로 메인 프로세스 방해 없음
- **상태 관리**: 각 모터별 독립적인 보정 상태 추적
