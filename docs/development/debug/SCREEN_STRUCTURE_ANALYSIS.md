# í™”ë©´ êµ¬ì¡° ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“± DoseTimeScreen (ë³µìš© ì‹œê°„ ì„¤ì • í™”ë©´)

### **í´ë˜ìŠ¤ ê°œìš”**
- **ëª©ì **: ê° ë³µìš© ì‹œê°„ì„ ì„¤ì •í•˜ëŠ” í™”ë©´ (ë¡¤ëŸ¬ UI ìŠ¤íƒ€ì¼)
- **íŒŒì¼**: `src/screens/dose_time_screen.py`
- **ì£¼ìš” ê¸°ëŠ¥**: ì‹œê°„/ë¶„ ì„¤ì •, ë³µìš© ì‹œê°„ ì €ì¥, ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ì „í™˜

### **í´ë˜ìŠ¤ êµ¬ì¡°**

#### **ì´ˆê¸°í™” (__init__)**
```python
def __init__(self, screen_manager, dose_count=1, selected_meals=None):
    # ê¸°ë³¸ ì†ì„±
    self.screen_manager = screen_manager
    self.screen_name = 'dose_time'
    self.screen_obj = None
    
    # ë³µìš© ì‹œê°„ ê´€ë ¨
    self.dose_count = dose_count
    self.selected_meals = selected_meals or []
    self.dose_times = []
    self.current_dose_index = 0
    self.current_hour = 8
    self.current_minute = 0
    self.editing_hour = True
    
    # UI ê°ì²´ë“¤
    self.hour_roller = None
    self.minute_roller = None
    self.ui_style = None  # ì§€ì—° ì´ˆê¸°í™”
```

#### **ì£¼ìš” ë©”ì„œë“œ**

##### **1. UI ê´€ë¦¬**
- `_ensure_ui_style()`: UI ìŠ¤íƒ€ì¼ ì§€ì—° ì´ˆê¸°í™”
- `_create_simple_screen()`: ê°„ë‹¨í•œ í™”ë©´ ìƒì„±
- `_update_title_text()`: ì œëª© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸

##### **2. ì‹œê°„ ì„¤ì •**
- `_set_default_time_from_meals()`: ì„ íƒëœ ì‹ì‚¬ ì‹œê°„ì— ë”°ë¼ ê¸°ë³¸ ì‹œê°„ ì„¤ì •
- `_next_time_setup()`: ë‹¤ìŒ ë³µìš© ì‹œê°„ ì„¤ì • ë˜ëŠ” ì™„ë£Œ
- `_save_current_time()`: í˜„ì¬ ì‹œê°„ ì €ì¥

##### **3. ë²„íŠ¼ ì²˜ë¦¬**
- `on_button_a()`: ë²„íŠ¼ A - ìœ„/ì´ì „
- `on_button_b()`: ë²„íŠ¼ B - ì•„ë˜/ë‹¤ìŒ
- `on_button_c()`: ë²„íŠ¼ C - ë’¤ë¡œê°€ê¸°
- `on_button_d()`: ë²„íŠ¼ D - ì„ íƒ/í™•ì¸

##### **4. í™”ë©´ ì „í™˜**
- `show()`: í™”ë©´ í‘œì‹œ
- `hide()`: í™”ë©´ ìˆ¨ê¹€
- `_next_time_setup()`: ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ì „í™˜ (pill_loading)

### **ë©”ëª¨ë¦¬ ìµœì í™” íŠ¹ì§•**
- **ì§€ì—° ì´ˆê¸°í™”**: `ui_style = None`ìœ¼ë¡œ ì‹œì‘, í•„ìš”ì‹œì—ë§Œ ì´ˆê¸°í™”
- **í™”ë©´ ì •ë¦¬**: ì´ì „ í™”ë©´ë“¤ ì •ë¦¬ë¡œ ë©”ëª¨ë¦¬ ì ˆì•½
- **ê°€ë¹„ì§€ ì»¬ë ‰ì…˜**: í™”ë©´ ì „í™˜ ì „ ë©”ëª¨ë¦¬ ì •ë¦¬

---

## ğŸ’Š PillLoadingScreen (ì•Œì•½ ì¶©ì „ í™”ë©´)

### **í´ë˜ìŠ¤ ê°œìš”**
- **ëª©ì **: ì•Œì•½ì„ ë””ìŠ¤í¬ì— ì¶©ì „í•˜ëŠ” í™”ë©´
- **íŒŒì¼**: `src/screens/pill_loading_screen.py`
- **ì£¼ìš” ê¸°ëŠ¥**: ë””ìŠ¤í¬ ì„ íƒ, ì•Œì•½ ì¶©ì „, ìˆœì°¨ì  ì¶©ì „, ëª¨í„° ì œì–´

### **í´ë˜ìŠ¤ êµ¬ì¡°**

#### **ì´ˆê¸°í™” (__init__)**
```python
def __init__(self, screen_manager):
    # ê¸°ë³¸ ì†ì„±
    self.screen_manager = screen_manager
    self.screen_name = 'pill_loading'
    self.screen_obj = None
    
    # ë””ìŠ¤í¬ ê´€ë ¨
    self.selected_disk_index = 0
    self.is_loading = False
    self.loading_progress = 0
    self.current_mode = 'selection'
    self.current_disk_state = None
    
    # ì‹ì‚¬ ì‹œê°„ ë§¤í•‘
    self.meal_to_disk_mapping = {
        'breakfast': 0,  # ì•„ì¹¨ â†’ ë””ìŠ¤í¬ 1
        'lunch': 1,      # ì ì‹¬ â†’ ë””ìŠ¤í¬ 2
        'dinner': 2      # ì €ë… â†’ ë””ìŠ¤í¬ 3
    }
    
    # ë³µìš© ì‹œê°„ ì •ë³´
    self.dose_times = []
    self.selected_meals = []
    self.available_disks = []
    
    # ìˆœì°¨ì  ì¶©ì „
    self.sequential_mode = False
    self.current_sequential_index = 0
    self.sequential_disks = []
    
    # ì§€ì—° ì´ˆê¸°í™” ê°ì²´ë“¤
    self.disk_states = {}
    self._disk_states_loaded = False
    self.ui_style = None
    self.motor_system = None
```

#### **ì£¼ìš” ë©”ì„œë“œ**

##### **1. ì§€ì—° ì´ˆê¸°í™”**
- `_ensure_ui_style()`: UI ìŠ¤íƒ€ì¼ ì§€ì—° ì´ˆê¸°í™”
- `_ensure_motor_system()`: ëª¨í„° ì‹œìŠ¤í…œ ì§€ì—° ì´ˆê¸°í™”
- `_ensure_disk_states()`: ë””ìŠ¤í¬ ìƒíƒœ ì§€ì—° ì´ˆê¸°í™”

##### **2. í™”ë©´ ìƒì„±**
- `_create_modern_screen()`: Modern í™”ë©´ ìƒì„±
- `_create_loading_sub_screen()`: ì¶©ì „ ì„œë¸Œ í™”ë©´ ìƒì„±
- `_create_loading_screen_directly()`: ì§ì ‘ ì¶©ì „ í™”ë©´ ìƒì„±

##### **3. ì¶©ì „ ê´€ë¦¬**
- `start_sequential_loading()`: ìˆœì°¨ì  ì¶©ì „ ì‹œì‘
- `_real_loading()`: ì‹¤ì œ ëª¨í„° ì œì–´ë¥¼ í†µí•œ ì•Œì•½ ì¶©ì „
- `_save_disk_states()`: ë””ìŠ¤í¬ ì¶©ì „ ìƒíƒœ ì €ì¥

##### **4. ë²„íŠ¼ ì²˜ë¦¬**
- `on_button_a()`: ë²„íŠ¼ A - ë””ìŠ¤í¬ íšŒì „ (ë¹„í™œì„±í™”)
- `on_button_b()`: ë²„íŠ¼ B - ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ (ë©”ì¸ í™”ë©´)
- `on_button_c()`: ë²„íŠ¼ C - ì¶©ì „ ì™„ë£Œ
- `on_button_d()`: ë²„íŠ¼ D - ë””ìŠ¤í¬ ì„ íƒ/ì¶©ì „ ì‹¤í–‰

##### **5. ë°ì´í„° ê´€ë¦¬**
- `update_dose_times()`: ë³µìš© ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
- `_load_disk_states()`: ì €ì¥ëœ ë””ìŠ¤í¬ ì¶©ì „ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
- `_save_disk_states()`: ë””ìŠ¤í¬ ì¶©ì „ ìƒíƒœ ì €ì¥

### **DiskState í´ë˜ìŠ¤**
```python
class DiskState:
    def __init__(self, disk_id):
        self.disk_id = disk_id
        self.total_compartments = 15  # ì´ 15ì¹¸
        self.compartments_per_loading = 3  # í•œ ë²ˆì— 3ì¹¸ì”© ì¶©ì „
        self.loaded_count = 0  # ì¶©ì „ëœ ì¹¸ ìˆ˜
        self.is_loading = False  # í˜„ì¬ ì¶©ì „ ì¤‘ì¸ì§€ ì—¬ë¶€
        self.current_loading_count = 0  # í˜„ì¬ ì¶©ì „ ì¤‘ì¸ ì¹¸ ìˆ˜
```

### **ë©”ëª¨ë¦¬ ìµœì í™” íŠ¹ì§•**
- **ì§€ì—° ì´ˆê¸°í™”**: UI ìŠ¤íƒ€ì¼, ëª¨í„° ì‹œìŠ¤í…œ, ë””ìŠ¤í¬ ìƒíƒœ ëª¨ë‘ ì§€ì—° ì´ˆê¸°í™”
- **íŒŒì¼ I/O ìµœì†Œí™”**: ë””ìŠ¤í¬ ìƒíƒœ ë¡œë”©ì„ í•„ìš”ì‹œì—ë§Œ ìˆ˜í–‰
- **ë©”ëª¨ë¦¬ ì •ë¦¬**: ê° ì´ˆê¸°í™” ì „ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìˆ˜í–‰

---

## ğŸ”„ í™”ë©´ ì „í™˜ í”Œë¡œìš°

### **DoseTimeScreen â†’ PillLoadingScreen**
1. **ì‹œê°„ ì„¤ì • ì™„ë£Œ**: `_next_time_setup()` í˜¸ì¶œ
2. **ì´ì „ í™”ë©´ ì •ë¦¬**: startup, wifi_scan, meal_time í™”ë©´ ì •ë¦¬
3. **ë©”ëª¨ë¦¬ ì •ë¦¬**: 5íšŒ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜
4. **PillLoadingScreen ìƒì„±**: ì„í¬íŠ¸ â†’ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± â†’ ë“±ë¡
5. **í™”ë©´ ì „í™˜**: `show_screen('pill_loading')`

### **ë©”ëª¨ë¦¬ ì‚¬ìš© íŒ¨í„´**
- **DoseTimeScreen**: ~50KB
- **í™”ë©´ ì •ë¦¬ í›„**: ~100KB
- **PillLoadingScreen ìƒì„± ì‹œ**: ~162KB (ë¬¸ì œ ì§€ì )

---

## ğŸš¨ ë©”ëª¨ë¦¬ ë¬¸ì œ ë¶„ì„

### **ë¬¸ì œ ì§€ì **
1. **PillLoadingScreen ì„í¬íŠ¸**: í´ë˜ìŠ¤ ë¡œë”© ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©
2. **ì¸ìŠ¤í„´ìŠ¤ ìƒì„±**: `__init__` ë©”ì„œë“œ ì‹¤í–‰ ì‹œ ë©”ëª¨ë¦¬ í• ë‹¹
3. **UI ê°ì²´ ìƒì„±**: LVGL ê°ì²´ë“¤ ìƒì„± ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©

### **í•´ê²° ë°©ì•ˆ**
1. **ì§€ì—° ì´ˆê¸°í™”**: ëª¨ë“  ë¬´ê±°ìš´ ê°ì²´ë“¤ì„ í•„ìš”ì‹œì—ë§Œ ì´ˆê¸°í™”
2. **í™”ë©´ ì •ë¦¬**: ì´ì „ í™”ë©´ë“¤ì˜ LVGL ê°ì²´ ì™„ì „ ì‚­ì œ
3. **ë©”ëª¨ë¦¬ ì •ë¦¬**: ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ê°•í™”
4. **ëŒ€ì²´ ê²½ë¡œ**: ì‹¤íŒ¨ ì‹œ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™

---

## ğŸ“Š ì„±ëŠ¥ ë¹„êµ

| í•­ëª© | DoseTimeScreen | PillLoadingScreen |
|------|----------------|-------------------|
| **ì´ˆê¸°í™” ì†ë„** | ë¹ ë¦„ | ëŠë¦¼ (ì§€ì—° ì´ˆê¸°í™”) |
| **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰** | ë‚®ìŒ (~50KB) | ë†’ìŒ (~162KB) |
| **UI ë³µì¡ë„** | ë‹¨ìˆœ (ë¡¤ëŸ¬ 2ê°œ) | ë³µì¡ (ì•„í¬, ì§„í–‰ë¥ , ë²„íŠ¼) |
| **ê¸°ëŠ¥ ë³µì¡ë„** | ë‹¨ìˆœ (ì‹œê°„ ì„¤ì •) | ë³µì¡ (ëª¨í„° ì œì–´, ì¶©ì „) |
| **ë©”ëª¨ë¦¬ ìµœì í™”** | ê¸°ë³¸ | ê³ ê¸‰ (ì§€ì—° ì´ˆê¸°í™”) |

---

## ğŸ¯ ê¶Œì¥ ì‚¬í•­

### **DoseTimeScreen**
- í˜„ì¬ êµ¬ì¡°ê°€ ì ì ˆí•¨
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë‚®ì•„ ì¶”ê°€ ìµœì í™” ë¶ˆí•„ìš”

### **PillLoadingScreen**
- ì§€ì—° ì´ˆê¸°í™” íŒ¨í„´ ìœ ì§€
- ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ê°•í™”
- ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ê²½ë¡œ ì œê³µ

### **ì „ì²´ ì‹œìŠ¤í…œ**
- í™”ë©´ ì „í™˜ ì‹œ ë©”ëª¨ë¦¬ ì •ë¦¬ ê°•í™”
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ì¶”ê°€
- ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”

**ë‘ í™”ë©´ ëª¨ë‘ ë©”ëª¨ë¦¬ ìµœì í™”ê°€ ì˜ ì ìš©ë˜ì–´ ìˆìœ¼ë©°, PillLoadingScreenì˜ ì§€ì—° ì´ˆê¸°í™” íŒ¨í„´ì´ í•µì‹¬ í•´ê²°ì±…ì…ë‹ˆë‹¤.** ğŸš€ğŸ’¾
